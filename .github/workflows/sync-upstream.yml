name: Sync Fork with Upstream

on:
  schedule:
    # Run every 4 hours
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/aliyss/syncribullet.git || true
          git fetch upstream

      - name: Check for updates and sync
        id: sync
        run: |
          # Get the default branch name
          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          echo "Default branch: $DEFAULT_BRANCH"

          # Compare with upstream
          git fetch upstream $DEFAULT_BRANCH

          LOCAL_HASH=$(git rev-parse HEAD)
          UPSTREAM_HASH=$(git rev-parse upstream/$DEFAULT_BRANCH)

          echo "Local: $LOCAL_HASH"
          echo "Upstream: $UPSTREAM_HASH"

          if [ "$LOCAL_HASH" != "$UPSTREAM_HASH" ]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ New changes detected in upstream, syncing..."

            # Merge upstream changes
            git merge upstream/$DEFAULT_BRANCH --no-edit || {
              echo "âŒ Merge conflict detected. Manual intervention required."
              exit 1
            }

            # Push to fork
            git push origin $DEFAULT_BRANCH
            echo "âœ… Successfully synced with upstream"
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "âœ… Fork is up to date with upstream"
          fi

      - name: Trigger Docker build
        if: steps.sync.outputs.changes_detected == 'true'
        run: |
          echo "ðŸš€ New changes synced - Docker build workflow will be triggered automatically"
